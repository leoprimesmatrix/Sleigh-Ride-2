<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sleigh Ride 2: The Forgotten Winter</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Share+Tech+Mono&display=swap');
    
    body {
      font-family: 'Share Tech Mono', monospace;
      background-color: #020410; /* Deep Winter Night */
      color: #e2e8f0;
      overflow: hidden;
    }

    /* Magical Text Effect */
    .magic-text {
      font-family: 'Cinzel', serif;
      text-shadow: 0 0 10px rgba(100, 200, 255, 0.6), 0 0 20px rgba(100, 200, 255, 0.4);
    }

    .runic-glow {
      color: #bfdbfe;
      text-shadow: 0 0 5px #60a5fa, 0 0 10px #2563eb;
    }

    /* Snowfall Overlay */
    .snow-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
      background-image: 
        radial-gradient(2px 2px at 20px 30px, #eee, rgba(0,0,0,0)),
        radial-gradient(2px 2px at 40px 70px, #fff, rgba(0,0,0,0)),
        radial-gradient(2px 2px at 50px 160px, #ddd, rgba(0,0,0,0)),
        radial-gradient(2px 2px at 90px 40px, #fff, rgba(0,0,0,0));
      background-size: 200px 200px;
      animation: snow 10s linear infinite;
    }

    @keyframes snow {
      0% { background-position: 0 0, 0 0, 0 0, 0 0; }
      100% { background-position: 400px 1000px, 400px 400px, 300px 300px, 200px 200px; }
    }

    /* Old World Flicker */
    .flicker {
      animation: flicker-anim 4s infinite;
    }

    @keyframes flicker-anim {
      0%, 19.999%, 22%, 62.999%, 64%, 64.999%, 70%, 100% {
        opacity: 1;
      }
      20%, 21.999%, 63%, 63.999%, 65%, 69.999% {
        opacity: 0.4;
      }
    }

    /* Loader Styles */
    #loader {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at center, #0f172a 0%, #020617 100%);
      z-index: 9999;
      transition: opacity 0.5s;
    }
    .loader-rune {
      width: 60px;
      height: 60px;
      border: 2px solid rgba(147, 197, 253, 0.2);
      border-top: 2px solid #60a5fa;
      border-radius: 50%;
      animation: spin 2s linear infinite;
      margin-bottom: 20px;
      box-shadow: 0 0 30px rgba(37, 99, 235, 0.3);
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
    "lucide-react": "https://esm.sh/lucide-react@0.263.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>
<body>
  <div id="root"></div>
  
  <div id="loader">
    <div class="loader-rune"></div>
    <h2 class="magic-text text-xl text-blue-200 tracking-[0.3em]">AWAKENING SPIRIT</h2>
    <p id="loader-status" class="text-blue-400/60 text-xs mt-2 font-mono">RECALLING MEMORIES...</p>
    <div id="error-container" class="hidden mt-4 p-4 bg-red-950 border border-red-500 rounded text-red-200 text-xs text-left max-w-md overflow-auto max-h-60 whitespace-pre-wrap font-mono"></div>
  </div>

  <script>
    async function loadGame() {
      const status = document.getElementById('loader-status');
      const errorContainer = document.getElementById('error-container');
      
      const path = window.location.pathname;
      if (!path.endsWith('/') && !path.endsWith('.html')) {
        const newUrl = window.location.href.replace(path, path + '/');
        window.location.replace(newUrl);
        return; 
      }

      function showError(msg, details = "") {
        status.innerText = "SPIRIT FRACTURED";
        status.style.color = "#ef4444";
        errorContainer.classList.remove('hidden');
        errorContainer.innerHTML = `<strong>${msg}</strong><br/><br/>${details}`;
      }

      const fileMap = {
        'types.ts': './types.ts',
        'constants.ts': './constants.ts',
        'audio.ts': './audio.ts',
        'VictorySequence.tsx': './components/VictorySequence.tsx',
        'UIOverlay.tsx': './components/UIOverlay.tsx',
        'GameCanvas.tsx': './components/GameCanvas.tsx',
        'App.tsx': './App.tsx',
        'index.tsx': './index.tsx'
      };

      const blobUrls = {};

      async function fetchWithFallback(url) {
        try {
          const res = await fetch(url);
          if (res.ok) return await res.text();
          throw new Error(`HTTP ${res.status}`);
        } catch (err) {
          const parts = url.split('/');
          const filename = parts.pop();
          const capitalized = filename.charAt(0).toUpperCase() + filename.slice(1);
          const newUrl = [...parts, capitalized].join('/');
          
          if (newUrl !== url) {
             const retryRes = await fetch(newUrl);
             if (retryRes.ok) return await retryRes.text();
          }
          throw err;
        }
      }

      try {
        if (window.location.protocol === 'file:') throw new Error("CORS_ERROR");

        for (const [moduleName, serverPath] of Object.entries(fileMap)) {
          status.innerText = `RESTORING ${moduleName}...`;
          
          try {
            let code = await fetchWithFallback(serverPath);
            code = code.replace(/(from\s+['"])(?:.*\/)?([a-zA-Z0-9_-]+\.[a-zA-Z]+)(['"])/g, '$1$2$3');

            const result = Babel.transform(code, {
              presets: [['react', { runtime: 'automatic' }], 'typescript'],
              filename: moduleName,
            });

            const blob = new Blob([result.code], { type: 'text/javascript' });
            blobUrls[moduleName] = URL.createObjectURL(blob);

          } catch (fetchErr) {
            console.error(fetchErr);
            if (fetchErr.message === 'CORS_ERROR') throw new Error("CORS RESTRICTION DETECTED");
            throw new Error(`LOAD ERROR ${moduleName}: ${fetchErr.message}`);
          }
        }

        const existingMapEl = document.querySelector('script[type="importmap"]');
        const imports = existingMapEl ? JSON.parse(existingMapEl.textContent).imports : {};

        for (const [moduleName, blobUrl] of Object.entries(blobUrls)) {
          imports[moduleName] = blobUrl;
        }

        const mapEl = document.createElement('script');
        mapEl.type = 'importmap';
        mapEl.textContent = JSON.stringify({ imports });
        document.head.appendChild(mapEl);

        status.innerText = "MANIFESTING...";
        await import(blobUrls['index.tsx']);
        
        const loader = document.getElementById('loader');
        loader.style.opacity = '0';
        setTimeout(() => loader.remove(), 500);

      } catch (error) {
        showError("CRITICAL MAGIC FAILURE", error.message);
      }
    }

    if (typeof Babel !== 'undefined') {
      loadGame();
    } else {
      document.querySelector('script[src*="babel"]').onload = loadGame;
    }
  </script>
</body>
</html>